<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EchoFlow Player</title>
<style>
  body {margin:0;background:#0e0f15;color:#fff;font-family:sans-serif;}
  .app {display:grid;grid-template-columns:260px 1fr;height:100vh;}
  aside {background:#121217;padding:12px;}
  main {display:flex;flex-direction:column;}
  .song{padding:8px;cursor:pointer;border-radius:6px;}
  .song:hover{background:#222;}
  .song.active{background:#1db95444;}
  footer{position:fixed;bottom:0;left:0;right:0;background:#18191f;
         display:flex;align-items:center;justify-content:center;gap:12px;
         padding:10px;}
  button{background:none;border:0;color:#fff;cursor:pointer;font-size:20px;}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h2>üéß EchoFlow</h2>
    <p style="font-size:12px;color:#aaa">Put songs in <code>/songs/</code> and reload.</p>
    <p id="status">Loading songs‚Ä¶</p>
  </aside>
  <main>
    <div id="songList" style="overflow:auto;flex:1;padding:12px"></div>
  </main>
</div>

<footer>
  <button id="prev">‚èÆ</button>
  <button id="play">‚ñ∂Ô∏è</button>
  <button id="next">‚è≠</button>
  <label style="font-size:12px"><input type="checkbox" id="shuffle"> Shuffle</label>
  <label style="font-size:12px"><input type="checkbox" id="order" checked> Play in order</label>
</footer>

<audio id="audio"></audio>

<script>
const SONGS_PATH = "songs/"; 
const audio = document.getElementById("audio");
const listEl = document.getElementById("songList");
const status = document.getElementById("status");
const playBtn = document.getElementById("play");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const shuffleToggle = document.getElementById("shuffle");
const orderToggle = document.getElementById("order");

let library = []; // [{file,title}]
let currentIndex = null;
let isPlaying = false;

async function loadSongs(){
  status.textContent = "Loading‚Ä¶";
  library = [];
  try {
    // Try to fetch directory listing HTML
    const res = await fetch(SONGS_PATH, {cache:"no-store"});
    const html = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html,"text/html");
    const links = Array.from(doc.querySelectorAll("a"));
    const files = links.map(a => decodeURIComponent(a.getAttribute("href")||""))
      .filter(h => /\.(mp3|ogg|wav|m4a)$/i.test(h));
    library = files.map(f => ({file:f,title:f.split("/").pop()}));
  } catch(e){
    console.error("Could not load directory:", e);
  }
  if(!library.length){
    status.textContent = "No songs found!";
    return;
  }
  status.textContent = `Loaded ${library.length} songs`;
  renderLibrary();
}

function renderLibrary(){
  listEl.innerHTML = "";
  library.forEach((song,idx)=>{
    const div=document.createElement("div");
    div.className="song";
    div.textContent=song.title;
    div.onclick=()=> playSongAt(idx);
    if(currentIndex===idx) div.classList.add("active");
    listEl.appendChild(div);
  });
}

function setActive(idx){
  currentIndex=idx;
  document.querySelectorAll(".song").forEach((s,i)=>{
    s.classList.toggle("active",i===idx);
  });
}

function playSongAt(idx){
  if(idx==null||!library[idx])return;
  setActive(idx);
  audio.src=SONGS_PATH+encodeURIComponent(library[idx].file);
  audio.play();
  isPlaying=true;
  updateUI();
}

function playNext(){
  if(shuffleToggle.checked){
    let rand;
    do{rand=Math.floor(Math.random()*library.length);}
    while(rand===currentIndex&&library.length>1);
    playSongAt(rand);
  } else {
    let next=currentIndex+1;
    if(next>=library.length) next=0;
    if(orderToggle.checked) playSongAt(next);
  }
}

function playPrev(){
  let prev=currentIndex-1;
  if(prev<0) prev=library.length-1;
  playSongAt(prev);
}

function updateUI(){
  playBtn.textContent=isPlaying?"‚è∏":"‚ñ∂Ô∏è";
}

playBtn.onclick=()=>{
  if(!audio.src&&library.length){playSongAt(0);return;}
  if(audio.paused){audio.play();isPlaying=true;}
  else {audio.pause();isPlaying=false;}
  updateUI();
};
nextBtn.onclick=playNext;
prevBtn.onclick=playPrev;

audio.addEventListener("ended",playNext);

loadSongs();
</script>
</body>
</html>
